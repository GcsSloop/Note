# 如何快速接手遗留项目

## 0. 前言

最近换工作了，到了一个新的环境，也即将开始一段新的征程，在新公司中，由于项目发展时间都比较久了，自然会存在一些遗留的项目，需要对这些项目进行修改，再次开发或者进行重构。我们都知道，当程序员比较痛苦的事情就是去看别人的代码，尤其是代码没有注释和文档的时候。比较有幸的是，我接手的项目质量都比较高，至少文档和必要的注释都存在，逻辑也很清晰。更好的是，项目的测试用例也比较完整，可见当初设计编写的人员还是非常认真负责的。说真的，在第一次看到这样完整清晰的代码时，确实也被惊艳了一下，感谢前辈可以留下这样一份比较漂亮的代码。

即便如此，为了理清整个项目的核心流程，花费了足足一周的时间，在梳理的过程中也稍微总结了一些查看遗留项目的诀窍，所以想和大家分享一下，可能会对部分人有所帮助，个人经验，仅供参考。

## 1. 明确方向

和阅读开源项目一样，在接手一个旧项目之前首先要明确的就是需求，了解这个项目需要实现的功能，有文档最好，没有文档可以找之前在这里的同事了解一下，明确知道项目具体是做什么的，要实现哪些基本的功能，对这些有了清晰的认知之后，才能更好的去理解项目，快速定位项目的核心逻辑。

通常来说，Android 相关项目至少会包括 3 部分内容：

1. 数据层(配置文件，数据库，网络库)
2. 业务层(各种业务逻辑的封装)
3. 展示层(最终展示给用户的部分)

当然对于部分项目来说，可能不会将这些逻辑划分的那么清晰，更有甚者，所有的逻辑都混在一起，但不论如何，项目中肯定会包括这些部分，在第一阶段，我们需要做的就是对项目整体有一个整体的认知，至少要知道这些部分都是放在哪里的，如何进行划分和组织的，或者说项目是如何堆砌的。

这一部分没有什么取巧的方案，主要还是看前人的风格，或者公司的规定，在前期只要能大致的定位这些主要的模块划分方案即可，主要用以后面的分析。

## 2. 技术基因

所谓技术还原就是找到技术的核心技术方案，例如数据库使用了什么方案，网络交互使用了什么方案，整体的结构使用了什么方案，以及对于特殊的需求是否有用到一些开源技术方案或者私有技术方案。

在真正看项目源码之前，看看这些技术方案自己是否都了解，会用，如果都是自己用过的，了解的自然最好，如果自己不太了解，或者是公司的私有技术方案，那么在看代码之前，最好先看一下这些自己不懂的技术方案的原理和使用方式。

用我自己的话来说，这些技术方案是项目的基因，也是整个项目的基石，如果对这些都不了解的话，那么直接看项目源码就像是雾里看花，始终看不真切，有些地方似乎看懂了，却又似懂非懂。遇到问题也无法下手。

> 例如：我接手过的一个项目用到了 Netty 框架，最初，我在不了解这个框架的前提下区看代码，只要追踪网络调用位置就很难再追踪下去了，因为再向下追踪就完全看不懂什么逻辑了。后来去查询了 Netty，通过官方文档和一些用例后，再去看就基本明白它是如何运作的了，也能进行一些简单的修改，调整。
>
> 当然，对于项目中所依赖的库，仅仅知道怎么用还不够的，会用仅仅是照葫芦画瓢，虽然程序能跑起来，但有些地方总归会感觉比较别扭，难以理解。所以之后我去了解了 Netty 的设计原理，在搞清楚设计原理后，再去查看项目中底层的网络交互逻辑，瞬间清晰了很多，也随之发现一些不合适的逻辑。

了解项目中使用到的技术方案是非常有必要的，只有这些懂了才能真正放心的去改代码。

正如房屋装修，只有拿到了设计图，知道房子是如何设计的才能安心的装修，知道那些地方能动，那些地方不能动。否则东一锤子漏水了，西一锤子漏电了，随便砸个墙结果把承重墙给砸了那后果就严重了。

所以在动手改旧项目之前，一定要搞明白它的设计方案，否则就可能出现只改了一行代码，结果整个系统就崩溃了的情况。

![change_one_line](http://gcsblog.oss-cn-shanghai.aliyuncs.com/blog/2019-05-25-143757.jpg?gcssloop)

## 3. 流程追踪

一般来说，遗留项目都会比较庞大，里面可能存在着大量的冗余逻辑和代码，也会可能沉睡着若干未知的 Bug，因此对于遗留代码来说，能不动就尽量不动，遇到是在必须要改的情况，一定要十分慎重，尽量减少干扰范围。



### 4.慎重重构



如果想要彻底的理解一个项目，就要先去理解项目的核心流程是如何运作的，都有哪些关键节点。
例如：应用核心是进行播放视频，就要去了解播放的数据源来自于哪里，网络还是本地，使用什么协议进行传输，使用了那种播放器，如何控制播放状态等，要从用户按下播放按钮追踪到整个播放流程结束，这样就能对播放流程有一个较为清楚的认知。  
又或者需要实现用户登录功能，当用户点击登录按钮后，是如何把用户输入的数据提交到服务器的，使用了哪些网络库与服务器直接交互，如何从服务器接收返回数据的，如何判断是否登录成功等，这些内容是一定要弄清楚的。







**理解目标，顺藤摸瓜**，任何项目都有其具体要实现的目标，首先要了解它需要实现哪些功能。根据功能大致可以猜测出可能会用到的技术方案，之后去观察源码，尝试找到使用这些技术方案的地方，如果没有找到，说明存在替代方案，到可能出现的位置去寻找相关的内容，一定存在替代的方案，之后去查找这些替代方案的相关资料。

**基因还原**，在项目中可能会存在一些自己完全没有使用过的技术方案，或者完全没有听说过的内容，对于这些内容一般分为两个部分，一部分是企业内部自研的技术方案，如果是这种情况，一般直接去问同事要相关资料就行了。另一种是一些相对不太常用的开源方案，这种情况需要先去网上了解一下这些开源方案的应用场景和使用方式，**因为项目中不论如何变化，最终还是离不开这些方案的基本操作的，这些就是项目的基因所在**，只要找到核心，依旧可以顺藤摸瓜，去寻找自己需要的内容。
若是自研方案，并且没有相关资料，那么只能自求多福了，不过还有一些方案可以稍微拯救一下，不论最终的技术方案如何，那么它依旧是有根基的，例如网络，一般情况下追踪 TCP/IP，Socket, nio 相关内容，就能查到有用的信息，实际上各种自研框架也是需要基础理论支持的，可能会存在原型，如果可以找到原型，那么理解起来就会相对简单一些。

**重构？** 一般来说接手旧项目，在观察代码时会发现一些不可思议的内容，例如：冗余代码，逻辑不合理。针对于这些内容一定要谨慎小心，因为这些代码的产生可能是有多种原因的，有可能只是前人疏忽所致，也有可能是受限于框架不得已为之，甚至可能是一个特殊的使用技巧，只是自己不太理解而已。针对于这种情况，一定要小心谨慎对待，不要按照自己既有的思路上手就去修改，否则可能会出现修复1个问题出现一堆问题的情况，对于自己认为比较奇怪的地方，优先请教同事，一般来说直接参与项目设计研发的同事对这些东西都了如指掌，大部分情况下都可以直接得到这样做的原因，但是如果不幸参与设计的同事离职了，其他同事又不太了解，那么只能靠自己探索了，先观察这些特殊的结构，尝试去理解它要完成的功能，之后去网络上搜一下有没有类似的用法，一般情况经过几轮搜索就可以找到自己想要的内容，尽量要在自己完全理解的情况下再去调整。



